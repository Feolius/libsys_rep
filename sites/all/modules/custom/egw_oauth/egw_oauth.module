<?php

/**
 * Implements hook_menu().
 */
function egw_oauth_menu() {
  $items['auth'] = array(
    'page callback' => 'egw_oauth_token_callback',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  $items['auth/login'] = array(
    'page callback' => 'egw_oauth_login_callback',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  return $items;
}

function egw_oauth_login_callback() {
  /*
  global $user;
  $user = user_load(2054);
  drupal_session_regenerate();
  drupal_goto('user');
*/

  $server_url = 'https://egwwritings.org/api/stable/auth';
  $client_url = '';
  $oauth2_config = array(
    'token_endpoint' => $server_url.'/token',
    'auth_flow' => 'server-side',
    'redirect_uri' => 'http://library.ellenwhite.org/auth/',
    'authorization_endpoint' => $server_url,
    'client_id' => 'RfznKiGZzQTHzrnZFi6tNSEbrb3bhzE3F3deaK5znK7K3iytzrN87eakh3ntkTfS',
    'client_secret' => 'HkZHZQ79k5Hbb6yBh8zedzskkGFAnQeZ35yNGsKYhhZkdfNkd8tfyKyHf38yEbfs',
    'scope' => 'user_info',
  );
  try {
    $oauth2_client = new OAuth2\Client($oauth2_config);
    $access_token = $oauth2_client->getAccessToken();
  }
  catch (Exception $e) {
    drupal_set_message($e->getMessage(), 'error');
  }
}

function egw_oauth_token_callback() {
  /*
  $myCurl = curl_init();
  curl_setopt_array($myCurl, array(
    CURLOPT_URL => 'https://egwwritings.org/api/stable/auth/token',
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_POST => true,
    CURLOPT_POSTFIELDS => http_build_query(array(
      'code' => $_GET['code'],
      'client_id' => 'RfznKiGZzQTHzrnZFi6tNSEbrb3bhzE3F3deaK5znK7K3iytzrN87eakh3ntkTfS',
      'client_secret' => 'HkZHZQ79k5Hbb6yBh8zedzskkGFAnQeZ35yNGsKYhhZkdfNkd8tfyKyHf38yEbfs',
      'redirect_uri' => 'http://library.ellenwhite.org/auth/',
      'grant_type' => 'authorization_code'
    ))
  ));
  $response = curl_exec($myCurl);
  $response_obj = json_decode($response);
  */
  $client_id = 'RfznKiGZzQTHzrnZFi6tNSEbrb3bhzE3F3deaK5znK7K3iytzrN87eakh3ntkTfS';
  $client_secret = 'HkZHZQ79k5Hbb6yBh8zedzskkGFAnQeZ35yNGsKYhhZkdfNkd8tfyKyHf38yEbfs';
  $options = array(
    'method' => 'POST',
    'data' => http_build_query(array(
      'grant_type' => 'authorization_code',
      'code' => $_GET['code'],
      'client_id' => $client_id,
      'client_secret' => $client_secret,
      'redirect_uri' => 'http://library.ellenwhite.org/auth/',
    )),
    'headers' => array(
      'Content-Type' => 'application/x-www-form-urlencoded',
      'Authorization' => 'Basic ' . base64_encode("$client_id:$client_secret"),
    ),
  );
  $token_endpoint = 'https://egwwritings.org/api/stable/auth/token/';
  $result = drupal_http_request($token_endpoint, $options);
  $token = json_decode($result->data);
  /*
    $myCurl = curl_init();
    curl_setopt_array($myCurl, array(
      CURLOPT_URL => 'https://egwwritings.org/api/2.3/info/',
      CURLOPT_RETURNTRANSFER => true,
      CURLOPT_POST => true,
      CURLOPT_POSTFIELDS => http_build_query(array(
        'client_id' => 'RfznKiGZzQTHzrnZFi6tNSEbrb3bhzE3F3deaK5znK7K3iytzrN87eakh3ntkTfS',
        'client_secret' => 'HkZHZQ79k5Hbb6yBh8zedzskkGFAnQeZ35yNGsKYhhZkdfNkd8tfyKyHf38yEbfs',
        'access_token' => $token->access_token,
        'token_type' => $token->token_type,
      ))
    ));

    $login_cred = curl_exec($myCurl);
    curl_close($myCurl);
  */

  $options = array(
    'method' => 'POST',
    'data' => http_build_query(array(
      'client_id' => $client_id,
      'client_secret' => $client_secret,
      'access_token' => $token->access_token,
      'token_type' => $token->token_type,
    )),
    'headers' => array(
      // 'Content-Type' => 'application/x-www-form-urlencoded',
      'Authorization' => 'Bearer '.$token->access_token,
    ),
  );
  $token_endpoint = 'https://egwwritings.org/api/2.3/info/';
  $login_cred = drupal_http_request($token_endpoint, $options);
  krumo($login_cred);

}