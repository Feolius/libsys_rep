<?php

function collection_page_menu()
{
    $items = array();
    $items['test-collection-page'] = array(
        'title' => 'Collection',
        'access callback' => TRUE,
        'page callback' => 'collection_page_collection_page_callback',
        'type' => MENU_CALLBACK,
    );
    $items['timeline-json'] = array(
        'access callback' => TRUE,
        'page callback' => 'collection_page_timeline_json_callback',
        'type' => MENU_CALLBACK,
    );
    $items['timeline-iframe'] = array(
        'access callback' => TRUE,
        'page callback' => 'collection_page_timeline_frame_callback',
        'type' => MENU_CALLBACK,
    );
    return $items;
}

function collection_page_collection_page_callback()
{
    $environment = apachesolr_default_environment();
    $solr = apachesolr_get_solr($environment);
    $params = facet_collection_get_params();
    $base_path = arg(0);
    $results = apachesolr_search_run('apachesolr', $params, '', $base_path, pager_find_page(), $solr);

    $node_ids = '';
    foreach ($results as $result) {
        $node_ids = $node_ids . ',' . $result['node']->entity_id;
    }
    $node_ids = substr($node_ids, 1);

    variable_set('collection_apache_solr_result', drupal_json_encode($results));

    drupal_add_css(drupal_get_path('module', 'collection_page') . '/css/collection_page_style.css');
    drupal_add_js(drupal_get_path('module', 'collection_page') . '/js/collection_page_tabs.js');
    drupal_add_library('system', 'ui.tabs');

    $content = array(
        '#timeline' => array(
            '#title' => t('Timeline View'),
            '#content' => array(
                '#timeline_iframe' => theme('timeline_iframe')
            )
        ),
        '#standart' => array(
            '#title' => t('Standart View'),
            '#content' => array(
                '#standart_view' => theme('search_results', array('#theme' => 'search_results', '#results' => $results, '#module' => 'collection_page')),
            )
        ),
        '#location' => array(
            '#title' => t('Location View'),
            '#content' => array(
                '#location_view' => views_embed_view('location_view', 'map', $node_ids),
            )
        ),
        '#pager' => theme('pager', array('tags' => NULL)),
    );

    return theme('collection_page', array('elements' => $content));
}

function collection_page_timeline_frame_callback()
{
    $options = new stdClass();
    $options->start_slide = 0;
    $options->timeline_lib_url = base_path() . libraries_get_path('timeline') . '/compiled/js/timeline-embed.js';
    echo theme('timeline_json', array('options' => $options));
    exit;
}

function collection_page_timeline_json_callback()
{

    $date = array();

    //TODO:rewrite result transmission
    $results = drupal_json_decode(variable_get('collection_apache_solr_result'));

    foreach ($results as $result) {
        $asset = new stdClass();
//        if (isset($_SESSION['collection_page']['json']['image_url']))
//            $asset->media = $_SESSION['collection_page']['json']['image_url'][$i];
//        else
        $asset->media = "";
        $asset->credit = "";
        $asset->caption = "";

        $item = new stdClass();
        $item->headline = $result['title'];
        $item->startDate = date('Y',strtotime($result['fields']['dm_field_files_date'][0]));
        $item->text = l('read more', 'http:' . $result['link'], array('attributes' => array('target' => '_parent', 'class' => 'active')));
        $item->asset = $asset;
        $date[] = $item;
    }

    $json_class = new stdClass();
    $json_class->timeline = new stdClass();
    $json_class->timeline->headline = "";
    $json_class->timeline->type = "default";
    $json_class->timeline->startDate = "0";
    $json_class->timeline->text = "";
    $json_class->timeline->date = $date;

    echo drupal_json_output($json_class);
    exit;
}

function collection_page_theme()
{
    return array(
        'collection_page' => array(
            'template' => 'theme/collection-page',
        ),
        'timeline_json' => array(
            'template' => 'theme/timeline-json-page',
            'arguments' => array(
                'options' => null,
            ),
        ),
        'timeline_iframe' => array(
            'template' => 'theme/timeline-iframe-page',
        )
    );
}

function collection_page_preprocess_timeline_json(&$vars)
{
    $options = $vars['options'];
    $vars['start_slide'] = $options->start_slide;
    $vars['timeline_lib_url'] = $options->timeline_lib_url;
    $vars['source'] = base_path() . 'timeline-json';
}

function collection_page_preprocess_timeline_iframe(&$vars)
{
    $vars['iframe_url'] = 'timeline-iframe';
    $vars['iframe_width'] = '100%';
    $vars['iframe_height'] = '600px';
}

function collection_page_apachesolr_query_alter($query)
{
    $query->addParam('fl', 'dm_field_files_date');
    $query->addFilter('bundle', 'files');
}